apiVersion: v1
kind: ConfigMap
metadata:
  name: qdrouterd-config-{{ item.name }}
data:
  qdrouterd.conf: |+
    # See the qdrouterd.conf (5) manual page for information about this
    # file's format and options.

    router {
        mode: interior
        id: central-qdr-{{ item.name }}
    }

    # This is for _client_ connections (senders and receivers, collectd wirtes to this )
    # to connect on port 5672:
    listener {
        host: 0.0.0.0
        port: amqp
        authenticatePeer: no
        saslMechanisms: ANONYMOUS
    }

    listener {
        host: 0.0.0.0
        port: 20001
        role: inter-router
        authenticatePeer: no
        saslMechanisms: ANONYMOUS
{% if sa_telemetry_node_labels[(label_index + 1)] is defined %}        failoverList: {{ sa_telemetry_node_labels[(label_index + 1)]['name'] }}.{{ sa_telemetry_qdr_hostname }}{% endif %}
    }

{% if sa_telemetry_node_labels[(label_index + 1)] is defined %}    connection {
        role: inter-router
        host: {{ sa_telemetry_node_labels[(label_index + 1)]['name'] }}.{{ sa_telemetry_qdr_hostname }}
        port: 20001
        saslMechanisms: ANONYMOUS
    }{% endif %}

    # Various address prefix -> distribution pattern
    # configurations:
    #
    address {
        prefix: closest
        distribution: closest
    }

    address {
        prefix: multicast
        distribution: multicast
    }

    address {
        prefix: unicast
        distribution: closest
    }

    address {
        prefix: exclusive
        distribution: closest
    }

    address {
        prefix: broadcast
        distribution: multicast
    }

    address {
        prefix: collectd/telemetry
        distribution: multicast
    }
